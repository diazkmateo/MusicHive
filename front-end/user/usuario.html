<!DOCTYPE html>
<html>
    <head>
        <title>MusicHive - Gestión de Usuarios</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/front-end/main.css">
        <link rel="stylesheet" type="text/css" href="/front-end/user/usuario.css">
        <!-- <link rel="stylesheet" type="text/css" href="/front-end/user/forms.css"> -->
    </head>

    <body>
        <header>
            <h1>MusicHive</h1>
        </header>

        <div class="container">
            <a href="/front-end/dashboard.html" class="back-link">← Volver al Dashboard</a>

            <section class="usuario-section">
                <h2>Crear/Editar Usuario</h2>
                <form id="usuario-form" class="usuario-form">
                    <input type="hidden" id="edit-usuario-id">
                    <div class="form-group">
                        <label for="nombre_usuario">Nombre de Usuario</label>
                        <input type="text" id="nombre_usuario" name="nombre_usuario" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Correo Electrónico</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group" id="password-group">
                        <label for="contrasena">Contraseña</label>
                        <input type="password" id="contrasena" name="contrasena" required>
                    </div>
                    <div class="form-group">
                        <label for="rol_id">Rol</label>
                        <select id="rol_id" name="rol_id" required></select>
                    </div>
                    <button type="submit" id="submit-button">Crear Usuario</button>
                    <button type="button" id="cancel-edit-button" style="display:none;" onclick="cancelarEdicion()">Cancelar Edición</button>
                </form>
            </section>
            
            <section class="usuario-section">
                <h2>Usuarios Creados</h2>
                <div id="usuarios-container" class="ratings-list"></div>
            </section>
        </div>

        <script>
            let todosLosRoles = [];

            window.addEventListener('DOMContentLoaded', async () => {
                const token = localStorage.getItem('jwt-token');
                if (!token) {
                    window.location.href = '/front-end/user/login.html';
                    return;
                }
                
                // Redirigir si no es admin
                const res = await fetch('/auth/me', { headers: { 'Authorization': 'Bearer ' + token } });
                if (res.ok) {
                    const user = await res.json();
                    if (!user.rol || user.rol.toLowerCase() !== 'admin') {
                        alert('Acceso denegado');
                        window.location.href = '/front-end/dashboard.html';
                    }
                } else {
                    window.location.href = '/front-end/user/login.html';
                }

                await cargarRoles();
                await cargarUsuarios();
            });

            async function cargarRoles() {
                const response = await fetch('/rol/', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('jwt-token') } });
                todosLosRoles = await response.json();
                const select = document.getElementById('rol_id');
                select.innerHTML = '';
                todosLosRoles.forEach(rol => {
                    const option = document.createElement('option');
                    option.value = rol.id;
                    option.textContent = rol.nombre_rol;
                    select.appendChild(option);
                });
            }

            async function cargarUsuarios() {
                const response = await fetch('/usuario/', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('jwt-token') } });
                const usuarios = await response.json();
                const container = document.getElementById('usuarios-container');
                container.innerHTML = '';
                usuarios.forEach(usuario => addUsuarioToList(usuario));
            }

            function addUsuarioToList(usuario) {
                const container = document.getElementById('usuarios-container');
                const usuarioElement = document.createElement('div');
                usuarioElement.className = 'rating-item';

                // Buscar el nombre del rol
                const rol = todosLosRoles.find(r => r.id === usuario.rol_id);
                const nombreRol = rol ? rol.nombre_rol : 'Desconocido';

                usuarioElement.innerHTML = `
                    <div class="rating-header">
                        <h4>${usuario.nombre_usuario}</h4>
                        <div>
                            <button class="edit-btn" onclick='editarUsuario(${JSON.stringify(usuario)})'>Editar</button>
                            <span onclick="borrarUsuario(${usuario.id})" class="delete-x" title="Borrar usuario">×</span>
                        </div>
                    </div>
                    <div class="rating-content">
                        <p><strong>ID:</strong> ${usuario.id}</p>
                        <p><strong>Email:</strong> ${usuario.email}</p>
                        <p><strong>Rol:</strong> ${nombreRol}</p>
                    </div>
                `;
                container.appendChild(usuarioElement);
            }
            
            function editarUsuario(usuario) {
                document.getElementById('edit-usuario-id').value = usuario.id;
                document.getElementById('nombre_usuario').value = usuario.nombre_usuario;
                document.getElementById('email').value = usuario.email;
                document.getElementById('rol_id').value = usuario.rol_id;

                // Deshabilitar campos que no se editan y ocultar contraseña
                document.getElementById('nombre_usuario').disabled = true;
                document.getElementById('email').disabled = true;
                document.getElementById('password-group').style.display = 'none';
                document.getElementById('contrasena').required = false;

                document.getElementById('submit-button').textContent = 'Actualizar Rol';
                document.getElementById('cancel-edit-button').style.display = 'inline-block';
                window.scrollTo(0, 0); // Subir al formulario
            }

            function cancelarEdicion() {
                document.getElementById('usuario-form').reset();
                document.getElementById('edit-usuario-id').value = '';
                
                document.getElementById('nombre_usuario').disabled = false;
                document.getElementById('email').disabled = false;
                document.getElementById('password-group').style.display = 'block';
                document.getElementById('contrasena').required = true;

                document.getElementById('submit-button').textContent = 'Crear Usuario';
                document.getElementById('cancel-edit-button').style.display = 'none';
            }

            async function borrarUsuario(id) {
                if (!confirm('¿Estás seguro de que quieres borrar este usuario?')) return;
                const response = await fetch(`/usuario/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('jwt-token') }
                });
                if (response.ok) {
                    alert('Usuario borrado exitosamente');
                    cargarUsuarios();
                } else {
                    alert('Error al borrar usuario');
                }
            }

            document.getElementById('usuario-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const editId = document.getElementById('edit-usuario-id').value;

                if (editId) { // Actualizar rol
                    const payload = { rol_id: parseInt(document.getElementById('rol_id').value) };
                    const response = await fetch(`/usuario/${editId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('jwt-token')
                        },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        alert('Usuario actualizado exitosamente');
                        cancelarEdicion();
                        cargarUsuarios();
                    } else {
                        alert('Error al actualizar usuario');
                    }
                } else { // Crear usuario
                    const payload = {
                        nombre_usuario: document.getElementById('nombre_usuario').value,
                        contrasena_hash: document.getElementById('contrasena').value,
                        email: document.getElementById('email').value,
                        rol_id: parseInt(document.getElementById('rol_id').value)
                    };
                    const response = await fetch('/usuario/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + localStorage.getItem('jwt-token')
                        },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        alert('Usuario creado exitosamente');
                        this.reset();
                        cargarUsuarios();
                    } else {
                        alert('Error al crear usuario');
                    }
                }
            });

        </script>
        <style>
            .edit-btn {
                padding: 3px 8px;
                font-size: 0.8rem;
                margin-right: 10px;
                background-color: var(--secondary-color);
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }
            .edit-btn:hover {
                opacity: 0.8;
            }
        </style>
    </body>
</html>